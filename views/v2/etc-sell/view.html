<!DOCTYPE html>
<html>
<head>
    <% include ../include/head.html %>
<script type="text/javascript">
    var userTag = "<%= userTag %>";
    var country = "<%= country %>";
    var itemId = "<%= id %>";
    var roomToken;
    var vtrTempId;
    var tradePointId;
    var buyerTag;
    var sellerTag;
    var vtrTempStatus;

    $(document).ready(function() {
        getData();
    });

    function getData() {
        $.ajax({
            method: "GET",
            url: "/v1/items/service/" + itemId
        }).done(function (success) {
            console.log(success);
            setTimeout(function(){
                $('.dataLoading').hide();
            }, 300)
            
            itemId = success.data._id;
            roomToken = success.data.roomToken;
            vtrTempId = success.data.vtrTempId;
            tradePointId = success.data.tradePointId;
            var regDate = success.data.regDate;
            var item_game_server = success.data.category1 == undefined ? '기타' : success.data.category1;
            var title = success.data.title;
            var price = numberWithCommas(success.data.price);
            var point = numberWithCommas(success.data.point);
            var status = getStatus(success.data.status);
            var delivery_type = getDelivery(success.data.delivery_type == undefined ? "direct" : success.data.delivery_type);
            var trade_type = replaceType(success.data.trade_type);
            var desc = replaceDesc(success.data.desc);
            var cryptoCurrencyCode = success.data.cryptoCurrencyCode == undefined ? "MACH" : success.data.cryptoCurrencyCode;
            buyerTag = success.data.vtrTemp == undefined ? "" : success.data.vtrTemp.buyer_id;
            sellerTag = success.data.vtrTemp == undefined ? "" : success.data.vtrTemp.seller_id;
            vtrTempStatus = success.data.vtrTemp == undefined ? "" : success.data.vtrTemp.item.status;
            
            // 이미지 모두 지운 상황이 아닌 경우
            if(success.data.images[0] !== null) {
                var img1th = success.data.images.length == 0 ? '' : "<img src=\"" + success.data.images[0].path + "\" data-file='"+success.data.images[0].origin_name+"'>";
                for(var i=0;i<success.data.images.length; i++) {
                    var html = "<div class=\"thumbnail_box\" id=\"img_id_"+i+"\">";
                        html += '<div class="img_view_area">';
                        html += "<img src=\"" + success.data.images[i].path + "\" data-file='"+success.data.images[0].origin_name+"'>";
                        html += '</div>';
                        html += '</div>';
                                                    
                    $("#listOfThumbnail li").eq(i).html(html);
                }
                $("#fullImg").html(img1th);
            }
            
            $(".view_emphasis").text(delivery_type.text);
            $(".posting_date").text("등록일 : " + regDate);
            $(".item_title").text(title);
            $(".item_game_server").text(item_game_server);
            $(".item_id").text(itemId);
            if("<%=useBlockchain%>" == 'Y') {
                $(".txt_price").html(price + "<span>"+cryptoCurrencyCode+"</span>");
            }
            if("<%=usePoint%>" == 'Y') { 
                $(".txt_point").html(point + "<span>Point</span>");
            }
            $(".item_desc").html(desc);
            $(".item_status").addClass(status.className).text(((success.data.status > 0 && success.data.status < 4)||success.data.status == 50 ||success.data.status == 5) && (success.data.vtr_btn_active) ? status.text+ ' - ' + status.detail : status.text);             
            $(".user_tag").text(success.data.userTag);

            if(success.data.status == "0") {
                if(userTag == success.data.userTag) {
                    if(buyerTag == "") {
                        $('#modify').css('display','inline-block');
                        $('#remove').css('display','inline-block');                            
                    } else {
                        $('#openVTR').css('display','inline-block');
                        $('#cancel').css('display','inline-block');
                    }
                } else {       
                    if(buyerTag == "") {                         
                        if(success.data.userTag !== "machprime") $('#regVTR').css('display','inline-block');
                        $('#buynow').css('display','inline-block');
                        $('#pointBuynow').css('display','inline-block');
                    } else {
                        if(userTag == buyerTag || userTag == sellerTag) {
                            $('#openVTR').css('display','inline-block');
                            $('#cancel').css('display','inline-block');
                        }
                    } 
                }
            } else if(success.data.status == "50") {
                $('#openVTR').css('display','inline-block');
                if(userTag == buyerTag || userTag == sellerTag) {
                    $('#cancel').css('display','inline-block');
                }
            } else if(success.data.status == "1") {
                if(success.data.vtr_btn_active && vtrTempStatus != "50") {
                    if(userTag != success.data.userTag) {
                        $('#buyComplete').css('display','inline-block');  
                    }
                    $('#openVTR').css('display','inline-block');
                    //$('#buynow').css('display','inline-block');  
                    $('#cancel').css('display','inline-block');
                }
            } else if(success.data.status == "2") {
                if(success.data.vtr_btn_active && vtrTempStatus != "50") {
                    if(userTag == success.data.userTag) {
                        $('#sellComplete').css('display','inline-block');                                
                    }
                    $('#openVTR').css('display','inline-block');
                    $('#cancel').css('display','inline-block');
                    $('#showPhone').css('display','inline-block');
                }
            } else if(success.data.status == "3") {
                if(success.data.vtr_btn_active && vtrTempStatus != "50") {
                    if(userTag != success.data.userTag) {
                        $('#confirm').css('display','inline-block');
                    } else {
                        $('#cancel').css('display','inline-block');
                    }
                    $('#openVTR').css('display','inline-block');
                    $('#showPhone').css('display','inline-block');
                    $('#opposition').css('display','inline-block');
                }
            } else if(success.data.status == "101") {
                if(success.data.point_btn_active && success.data.status != "50") {
                    if(userTag != success.data.userTag) {
                        $('#pointBuyComplete').css('display','inline-block');  
                    }
                    $('#pointCancel').css('display','inline-block');
                } else {
                    
                }
            } else if(success.data.status == "102") {
                if(success.data.point_btn_active) {
                    if(userTag == success.data.userTag) {
                        $('#pointSellComplete').css('display','inline-block');
                    }
                    $('#pointCancel').css('display','inline-block');
                    $('#pointShowPhone').css('display','inline-block');
                }
            } else if(success.data.status == "103") {
                if(success.data.point_btn_active) {
                    if(userTag != success.data.userTag) {
                        $('#pointConfirm').css('display','inline-block');
                    } else {
                        $('#pointCancel').css('display','inline-block');
                    }
                    $('#pointShowPhone').css('display','inline-block');
                    $('#opposition').css('display','inline-block');
                }
            } else if(success.data.status > 3) {
                if(success.data.vtr_btn_active) {
                    $('#showPhone').css('display','inline-block');
                    if(success.data.status == 5) {
                        $('#opposition').css('display','inline-block');
                    }
                }
            }
        }).fail(function (fail) {
            console.log(fail);
        })
    }
</script>
</head>
<body>
<div id="wrap" class="wrap">
    <!-- header -->
    <div class="header_wrap">
        <% include ../include/header.html %>
        <% include ../include/m_header.html %>
    </div>
    <!--// header -->

    <!-- content_wrap -->
    <div class="content_wrap">
        <div class="sub_container container">
            <!-- view page-->
            <%# section의 클래스명 추가= 팝니다: c_style_sell, 삽니다: c_style_buy %>
            <section class="board_sec c_style_sell">
                <div class="board_tit cf">
                    <h1>자산거래 팝니다<span>상세정보</span></h1>
                </div>

                <!-- 상품정보 : 이미지 업로드 UI 포함 -->
                <div class="table_wrap table-responsive">
                    <table class="table_view table">
                        <colgroup class="colgroup_etc-sell_view">
                            <col class="col2_1">
                            <col class="col2_2">
                        </colgroup>
                        <thead>
                            <tr>
                                <th colspan="2">
                                    <em class="view_emphasis"></em>  
                                    <span class="posting_date"></span>
                                </th>
                            </tr>
                            <tr>
                                <th colspan="2">
                                    <div class="ellipse item_title">
                                    </div>
                                </th>
                            </tr>
                        </thead>
                        <tbody>                           
                            <tr>
                                <th>카테고리</th>
                                <td><span class="item_game_server"></span></td>
                            </tr>
                            <tr>
                                <th>거래번호</th>
                                <td><span class="item_id"></span></td>
                            </tr>
                            <tr>
                                <th>작성자</th>
                                <td><span class="user_tag"></span></td>
                            </tr>
                            <tr>
                                <th>거래상태</th>
                                <td><span class="item_status"></span></td>
                            </tr>
                            <tr>
                                <th>거래가격</th>
                                <td><p class="txt_price"><span></span></p></td>
                            </tr>
                            <tr class="mrg_cell trForBtn">
                                <td colspan="2">
                                    <div class="btn_align_c">
                                        <%- include('../include/modules/trading_button.html', {pageName: 'etc-sells', category: 'etc', tradeType: 'sell'}) %>
                                    </div>
                                    <div class="tac">
                                        <a href="javascript:openVtrInfo()">VTR 거래신청이란?</a>
                                    </div>
                                </td>
                            </tr>
                            <tr class="mrg_cell trForDel">
                                <td colspan="2">
                                    <div id="fullImg"></div>
                                </td>
                            </tr>
                            <tr class="trForDel">
                                <th>상품이미지</th>
                                <td>
                                    <div class="product_img_list">
                                        <div class="imgs_wrap">
                                            <ul id="listOfThumbnail" class="list_of_thumbnail cf">
                                                <li></li>
                                                <li></li>
                                                <li></li>
                                                <li></li>
                                                <li></li>
                                            </ul>    
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <th>상세정보</th>
                                <td>
                                    <span class="item_desc">
                                    </span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <!--// 상품정보 : 이미지 업로드 UI 포함 -->

                <div class="tar">
                    <a href="javascript:routeLink()" class="btn btn_go_list">목록</a>
                    <!-- [모듈] 댓글모듈 -->
                    <% include ../include/modules/comment.html %>
                </div>

                <!-- 모달창 -->
                <div class="dim_all_area" style="display: none">
                    <article class="modal_bitberry_deposit">
                        <button id="btnmCloseModal" class="btn">X</button>
                        <h1>연락처 표시</h1>
                        <p>구매자 : <span id="to_userTag"></span><br> 연락처 : <span id="toPhone"></span></p>
                        <p>판매자 : <span id="from_userTag"></span><br> 연락처 : <span id="fromPhone"></span></p>
                        <button id="checkok" class="btn btn-danger">확인</button>
                    </article>
                </div>
            </section>
            <!--// view page-->
        </div>
    </div>
    <!--// content_wrap -->

    <% include ../include/footer.html %>
</div>
</body>        